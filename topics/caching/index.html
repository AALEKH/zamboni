<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Cache is King &mdash; zamboni v0.1 documentation</title>
    <link rel="stylesheet" href="../../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../static/jquery.js"></script>
    <script type="text/javascript" src="../../static/doctools.js"></script>
    <link rel="top" title="zamboni v0.1 documentation" href="../../" />
    <link rel="next" title="Django, the Good Parts" href="../django/" />
    <link rel="prev" title="Welcome to zamboni’s documentation!" href="../../" />
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../modindex/" title="Global Module Index"
             accesskey="M">modules</a> |</li>
        <li class="right" >
          <a href="../django/" title="Django, the Good Parts"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../../" title="Welcome to zamboni’s documentation!"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">zamboni v0.1 documentation</a> &raquo;</li>
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">

  <div class="section" id="module-caching">
<span id="caching"></span><h1>Cache is King<a class="headerlink" href="#module-caching" title="Permalink to this headline">¶</a></h1>
<p>To enable caching for a model, add the <a title="caching.caching.CachingManager" class="reference internal" href="#caching.caching.CachingManager"><tt class="xref docutils literal"><span class="pre">CachingManager</span></tt></a> to that
class.  If you want related (foreign key) lookups to hit the cache,
<tt class="docutils literal"><span class="pre">CachingManager</span></tt> must be the default manager.  If you have multiple managers
that should be cached, return a <a title="caching.caching.CachingQuerySet" class="reference internal" href="#caching.caching.CachingQuerySet"><tt class="xref docutils literal"><span class="pre">CachingQuerySet</span></tt></a> from the
other manager&#8217;s <tt class="docutils literal"><span class="pre">get_query_set</span></tt> method instead of subclassing
<tt class="docutils literal"><span class="pre">CachingManager</span></tt>, since that would hook up the post_save and post_delete
signals multiple times.</p>
<p>Whenever you run a query, <tt class="docutils literal"><span class="pre">CachingQuerySet</span></tt> will try to find that query in
the cache.  Queries are keyed by <tt class="docutils literal"><span class="pre">{locale}:{sql}</span></tt>. If it&#8217;s there, we return
the cached result set and everyone is happy.  If the query isn&#8217;t in the cache,
the normal codepath to run a database query is executed.  As the objects in the
result set are iterated over, they are added to a list that will get cached
once iteration is done.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Nothing will be cached if the QuerySet is not iterated through completely.</p>
</div>
<p>To support easy cache invalidation, we use &#8220;flush lists&#8221; to mark the cached
queries an object belongs to.  That way, all queries where an object was found
will be invalidated when that object changes.  Flush lists map an object key to
a list of query keys.</p>
<p>When an object is saved or deleted, all query keys in its flush list will be
deleted.  In addition, the flush lists of its foreign key relations will be
cleared.  To avoid stale foreign key relations, any cached objects will be
flushed when the object their foreign key points to is invalidated.</p>
<p>During cache invalidation, we explicitly set a None value instead of just
deleting so we don&#8217;t have any race condtions where:</p>
<blockquote>
<ul class="simple">
<li>Thread 1 -&gt; Cache miss, get object from DB</li>
<li>Thread 2 -&gt; Object saved, deleted from cache</li>
<li>Thread 1 -&gt; Store (stale) object fetched from DB in cache</li>
</ul>
</blockquote>
<p>The foundations of this module were derived from <a class="reference external" href="http://immike.net/">Mike Malone&#8217;s</a>
<a class="reference external" href="http://github.com/mmalone/django-caching/">django-caching</a>.</p>
<dl class="class">
<dt id="caching.caching.CachingManager">
<em class="property">class </em><tt class="descclassname">caching.</tt><tt class="descname">CachingManager</tt><a class="headerlink" href="#caching.caching.CachingManager" title="Permalink to this definition">¶</a></dt>
<dd>This <a title="(in Django v1.1)" class="reference external" href="http://docs.djangoproject.com/en/dev/topics/db/managers/#django.db.models.Manager"><tt class="xref docutils literal"><span class="pre">manager</span></tt></a> always returns a
<a title="caching.caching.CachingQuerySet" class="reference internal" href="#caching.caching.CachingQuerySet"><tt class="xref docutils literal"><span class="pre">CachingQuerySet</span></tt></a>, and hooks up <tt class="docutils literal"><span class="pre">post_save</span></tt> and
<tt class="docutils literal"><span class="pre">post_delete</span></tt> signals to invalidate caches.</dd></dl>

<dl class="class">
<dt id="caching.caching.CachingQuerySet">
<em class="property">class </em><tt class="descclassname">caching.</tt><tt class="descname">CachingQuerySet</tt><a class="headerlink" href="#caching.caching.CachingQuerySet" title="Permalink to this definition">¶</a></dt>
<dd>Overrides the default <a title="(in Django v1.1)" class="reference external" href="http://docs.djangoproject.com/en/dev/ref/models/querysets/#django.db.models.QuerySet"><tt class="xref docutils literal"><span class="pre">QuerySet</span></tt></a> to fetch objects
from cache before hitting the database.</dd></dl>

</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h4>Previous topic</h4>
            <p class="topless"><a href="../../"
                                  title="previous chapter">Welcome to zamboni&#8217;s documentation!</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="../django/"
                                  title="next chapter">Django, the Good Parts</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../sources/topics/caching.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../search/" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../modindex/" title="Global Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../django/" title="Django, the Good Parts"
             >next</a> |</li>
        <li class="right" >
          <a href="../../" title="Welcome to zamboni’s documentation!"
             >previous</a> |</li>
        <li><a href="../../">zamboni v0.1 documentation</a> &raquo;</li>
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, The Zamboni Collective.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.3.
    </div>
  </body>
</html>